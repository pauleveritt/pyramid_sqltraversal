<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ACLs &mdash; pyramid_sqltraversal 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pyramid_sqltraversal 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="Filtered Queries" href="../filtered_queries/index.html" />
    <link rel="prev" title="Parents in One Query" href="../parents/index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="acls">
<h1>ACLs<a class="headerlink" href="#acls" title="Permalink to this headline">¶</a></h1>
<p>Pyramid has a rich security model based on access control lists (ACLs).
A location-aware resource can provide an <code class="docutils literal"><span class="pre">__acl__</span></code> sequence of access
control entries (ACE), either on the class or instance. Views can then
state a permission needed to get to a certain URL. Pyramid will then
check the ACL, using the credentials of the user and the permission, to
see if access is allowed.</p>
<p>In this section we&#8217;re going to set this up to use ACLs stored in the
database. Specifically:</p>
<ul class="simple">
<li>Add the regular Pyramid authentication/authorization story, with a
<code class="docutils literal"><span class="pre">login</span></code> view</li>
<li>Make a database column capable of storing an ACL</li>
<li>Add a class-based ACL on the <code class="docutils literal"><span class="pre">Folder</span></code> model, but provide some
initial rows with an instance-based ACL in the column</li>
<li>Make a method in <code class="docutils literal"><span class="pre">Node</span></code> capable of sorting all this out</li>
</ul>
<div class="section" id="acl-column-type">
<h2>ACL Column Type<a class="headerlink" href="#acl-column-type" title="Permalink to this headline">¶</a></h2>
<p>Needless to say, storing in a column an array where the second item can
be an array is a bit of a trick. PostgreSQL has some advanced
facilities, including arrays, JSONB, and hstore. We&#8217;ll commit ourselves
to at this point to a <code class="docutils literal"><span class="pre">pyramid_sqlalchemy</span></code> that requires PostgreSQL
9.4+, and use JSONB.</p>
<p>This does mean that each change to the schema or initialize_db script
means:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ dropdb sqltraversal<span class="p">;</span> createdb -O sqltraversal sqltraversal
</pre></div>
</div>
<p>As a note, though, we are ignoring for a moment:</p>
<ul class="simple">
<li><em>Mutability</em>. SQLAlchemy can&#8217;t detect changes to these column types
without a little help. We&#8217;ll deal with that later. For now, we just
create the JSON data in <code class="docutils literal"><span class="pre">initialize_db</span></code> and don&#8217;t change it.</li>
<li><em>Hierarchies</em>. A later section will address looking at the resource
then its parents until finding a matching ACL.</li>
<li><em>Permission filtering in queries</em>. This is the big one, but out of
scope for now. We are only concerned with a URL that traverses to an
ACL-protected resource.</li>
</ul>
<p>We will, though, look for an ACL in the column and, if not present, use
an ACL on the class.</p>
</div>
<div class="section" id="authentication-and-authorizaton">
<h2>Authentication and Authorizaton<a class="headerlink" href="#authentication-and-authorizaton" title="Permalink to this headline">¶</a></h2>
<p>Standard Pyramid stuff here. Our <code class="docutils literal"><span class="pre">__init__.py</span></code> needs some additions:</p>
<div class="literal-block-wrapper container" id="mysite-init-py">
<div class="code-block-caption"><span class="caption-text">mysite/__init__.py</span><a class="headerlink" href="#mysite-init-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="k">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="k">import</span> <span class="n">ACLAuthorizationPolicy</span>
</span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="k">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">.models.node</span> <span class="k">import</span> <span class="n">root_factory</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.security</span> <span class="k">import</span> <span class="n">groupfinder</span>
</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
        <span class="n">root_factory</span><span class="o">=</span><span class="n">root_factory</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.models&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s1">&#39;.views&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;mysite:static&#39;</span><span class="p">)</span>

<span class="hll">    <span class="c1"># Security policies</span>
</span><span class="hll">    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span>
</span><span class="hll">        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth.secret&#39;</span><span class="p">],</span> <span class="n">callback</span><span class="o">=</span><span class="n">groupfinder</span><span class="p">,</span>
</span><span class="hll">        <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">authz_policy</span> <span class="o">=</span> <span class="n">ACLAuthorizationPolicy</span><span class="p">()</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">authz_policy</span><span class="p">)</span>
</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>We import our policies, as well as a &#8220;groupfinder&#8221; function used to get
principals from credentials. We then wire those policies into our
configuration.</p>
<p>Our configuration file needs a secret:</p>
<div class="literal-block-wrapper container" id="development-ini">
<div class="code-block-caption"><span class="caption-text">development.ini</span><a class="headerlink" href="#development-ini" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">app</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">mysite</span>
<span class="n">pyramid</span><span class="o">.</span><span class="n">reload_templates</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">pyramid</span><span class="o">.</span><span class="n">includes</span> <span class="o">=</span>
    <span class="n">pyramid_tm</span>
<span class="n">sqlalchemy</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">sqltraversal</span><span class="p">:</span><span class="n">sqltraversal</span><span class="nd">@localhost</span><span class="p">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">sqltraversal</span>
<span class="hll"><span class="n">auth</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">anothersecret</span>
</span>
<span class="p">[</span><span class="n">server</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">waitress</span><span class="c1">#main</span>
<span class="n">host</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">6543</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Here is a simple, in-memory database of users and roles, along with a
function used to retrieve from that &#8220;database:</p>
<div class="literal-block-wrapper container" id="mysite-security-py">
<div class="code-block-caption"><span class="caption-text">mysite/security.py</span><a class="headerlink" href="#mysite-security-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">USERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="s1">&#39;editor&#39;</span><span class="p">,</span>
         <span class="s1">&#39;viewer&#39;</span><span class="p">:</span> <span class="s1">&#39;viewer&#39;</span><span class="p">,</span>
         <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span><span class="p">}</span>
<span class="n">GROUPS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;group:editors&#39;</span><span class="p">],</span>
          <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;group:editors&#39;</span><span class="p">]}</span>


<span class="k">def</span> <span class="nf">groupfinder</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">userid</span> <span class="ow">in</span> <span class="n">USERS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GROUPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>
</td></tr></table></div>
</div>
<p>And finally, login/logout views on the <code class="docutils literal"><span class="pre">RootFolder</span></code>:</p>
<div class="literal-block-wrapper container" id="mysite-views-py">
<div class="code-block-caption"><span class="caption-text">mysite/views.py</span><a class="headerlink" href="#mysite-views-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="k">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="k">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">remember</span><span class="p">,</span> <span class="n">forget</span>
<span class="kn">from</span> <span class="nn">.models.folder</span> <span class="k">import</span> <span class="n">RootFolder</span><span class="p">,</span> <span class="n">Folder</span>
<span class="kn">from</span> <span class="nn">.models.document</span> <span class="k">import</span> <span class="n">Document</span>
<span class="kn">from</span> <span class="nn">.security</span> <span class="k">import</span> <span class="n">USERS</span>


<span class="k">class</span> <span class="nc">RootViews</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/root.jinja2&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">RootFolder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">__parent__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="hll">    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/login.jinja2&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/login.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">                 <span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">login_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
</span><span class="hll">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">USERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
</span><span class="hll">            <span class="n">headers</span> <span class="o">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</span><span class="hll">            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span>
</span><span class="hll">                <span class="n">location</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">root</span><span class="p">),</span>
</span><span class="hll">                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="hll">            <span class="n">form_error</span><span class="o">=</span><span class="s1">&#39;Invalid username or password&#39;</span><span class="p">,</span>
</span><span class="hll">            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span class="hll">            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;logout&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="n">headers</span> <span class="o">=</span> <span class="n">forget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
</span><span class="hll">        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span>

<span class="k">class</span> <span class="nc">FolderViews</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;templates/folder.jinja2&quot;</span><span class="p">,</span>
                 <span class="n">context</span><span class="o">=</span><span class="n">Folder</span><span class="p">,</span>
                 <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add_folder&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">Folder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make a new Folder</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;folder_title&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>

        <span class="n">new_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Folder</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># Redirect to the new folder</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">new_folder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DocumentViews</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add_document&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">Folder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make a new Document</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;document_title&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>
        <span class="n">new_document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># Redirect to the new document</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">new_document</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;templates/document.jinja2&quot;</span><span class="p">,</span>
                 <span class="n">context</span><span class="o">=</span><span class="n">Document</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>This also means a simple login form:</p>
<div class="literal-block-wrapper container" id="mysite-templates-login-jinja2">
<div class="code-block-caption"><span class="caption-text">mysite/templates/login.jinja2</span><a class="headerlink" href="#mysite-templates-login-jinja2" title="Permalink to this code">¶</a></div>
<div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.jinja2&quot;</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">Login </span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h2&gt;Login&lt;/h2&gt;</span>

<span class="x">    &lt;div class=&quot;col-md-6&quot;&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">form_error</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">form_error</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">          &lt;/div&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;form method=&quot;POST&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">                &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;</span>
<span class="x">                &lt;input class=&quot;form-control&quot; name=&quot;username&quot;</span>
<span class="x">                       id=&quot;username&quot; value=&quot;</span><span class="cp">{{</span> <span class="nv">username</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">            &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">                &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span>
<span class="x">                &lt;input type=&quot;password&quot; class=&quot;form-control&quot;</span>
<span class="x">                       name=&quot;password&quot;</span>
<span class="x">                       id=&quot;password&quot; value=&quot;</span><span class="cp">{{</span> <span class="nv">password</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">            &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Submit&lt;/button&gt;</span>
<span class="x">        &lt;/form&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id1">
<h2>ACLs<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s teach our models to do ACLs. First, our based model <code class="docutils literal"><span class="pre">Node</span></code>:</p>
<div class="literal-block-wrapper container" id="mysite-models-node-py">
<div class="code-block-caption"><span class="caption-text">mysite/models/node.py</span><a class="headerlink" href="#mysite-models-node-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">literal</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">relationship</span><span class="p">,</span>
    <span class="n">backref</span><span class="p">,</span>
    <span class="n">object_session</span><span class="p">,</span>
    <span class="n">aliased</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="k">import</span> <span class="n">JSONB</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="k">import</span> <span class="n">NoResultFound</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.util</span> <span class="k">import</span> <span class="n">classproperty</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Base</span>


<span class="k">def</span> <span class="nf">root_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;nodes&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;nodes.id&#39;</span><span class="p">))</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="hll">    <span class="n">acl</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">JSONB</span><span class="p">)</span>
</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">__mapper_args__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">polymorphic_on</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">,</span>
            <span class="n">polymorphic_identity</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="n">with_polymorphic</span><span class="o">=</span><span class="s1">&#39;*&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__parent__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lineage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="n">init_cte</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">Node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">Node</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
                <span class="n">literal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lineage&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">child_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">init_cte</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;child&#39;</span><span class="p">)</span>
        <span class="n">parent_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="n">lineage_cte</span> <span class="o">=</span> <span class="n">init_cte</span><span class="o">.</span><span class="n">union_all</span><span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">parent_alias</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">parent_alias</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
                <span class="n">child_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent_alias</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">child_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lineage_cte</span><span class="p">,</span> <span class="n">Node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">lineage_cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">lineage_cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="hll">    <span class="nd">@property</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="c1"># Later, use some trickeration to get the class acl without</span>
</span><span class="hll">        <span class="c1"># resorting to polymorphism</span>
</span><span class="hll">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;acl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">default_acl</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>The <code class="docutils literal"><span class="pre">__acl__</span></code> property tries first on the row, to see if the resource
has a &#8220;persistent&#8221; ACL stored. If not, it returns the ACL from the
model (or None if not present there either.) Here&#8217;s what the ACL on the
<code class="docutils literal"><span class="pre">Folder</span></code> model might look like:</p>
<div class="literal-block-wrapper container" id="mysite-models-folder-py">
<div class="code-block-caption"><span class="caption-text">mysite/models/folder.py</span><a class="headerlink" href="#mysite-models-folder-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span>
<span class="kn">from</span> <span class="nn">.node</span> <span class="k">import</span> <span class="n">Node</span>


<span class="k">class</span> <span class="nc">Folder</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;folders&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;nodes.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
<span class="hll">    <span class="n">default_acl</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">                   <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">)]</span>
</span>

<span class="k">class</span> <span class="nc">RootFolder</span><span class="p">(</span><span class="n">Folder</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Let&#8217;s setup our initialize script to make a folder without an ACL, as
we&#8217;ve done so far, but also a folder <em>with</em> an ACL:</p>
<div class="literal-block-wrapper container" id="mysite-scripts-initialize-db-py">
<div class="code-block-caption"><span class="caption-text">mysite/scripts/initialize_db.py</span><a class="headerlink" href="#mysite-scripts-initialize-db-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">transaction</span>
<span class="kn">from</span> <span class="nn">pyramid.paster</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_appsettings</span><span class="p">,</span>
    <span class="n">setup_logging</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">Allow</span><span class="p">,</span> <span class="n">Deny</span><span class="p">,</span> <span class="n">Everyone</span>
<span class="kn">from</span> <span class="nn">pyramid.scripts.common</span> <span class="k">import</span> <span class="n">parse_vars</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Base</span><span class="p">,</span>
    <span class="n">get_session</span><span class="p">,</span>
    <span class="n">get_engine</span><span class="p">,</span>
    <span class="n">get_dbmaker</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..models.folder</span> <span class="k">import</span> <span class="n">RootFolder</span><span class="p">,</span> <span class="n">Folder</span>
<span class="kn">from</span> <span class="nn">..models.document</span> <span class="k">import</span> <span class="n">Document</span>


<span class="k">def</span> <span class="nf">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;usage: </span><span class="si">%s</span><span class="s1"> &lt;config_uri&gt; [var=value]</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="s1">&#39;(example: &quot;</span><span class="si">%s</span><span class="s1"> development.ini&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">config_uri</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_vars</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">setup_logging</span><span class="p">(</span><span class="n">config_uri</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_appsettings</span><span class="p">(</span><span class="n">config_uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">dbmaker</span> <span class="o">=</span> <span class="n">get_dbmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">,</span> <span class="n">dbmaker</span><span class="p">)</span>

    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">RootFolder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;sqltraversal Demo&#39;</span>
                          <span class="p">)</span>
        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Folder</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Folder 1&#39;</span>
        <span class="p">)</span>
        <span class="n">f1</span><span class="p">[</span><span class="s1">&#39;d1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Document 1&#39;</span><span class="p">)</span>

        <span class="c1"># Add a folder that only admin can view</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;f2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Folder</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Admin-only folder&#39;</span><span class="p">,</span>
<span class="hll">            <span class="n">acl</span><span class="o">=</span><span class="p">[</span>
</span><span class="hll">                <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">                <span class="p">(</span><span class="n">Deny</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span><span class="hll">            <span class="p">]</span>
</span>        <span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>For this <code class="docutils literal"><span class="pre">/f2</span></code> folder, you can only view it if you are the <code class="docutils literal"><span class="pre">admin</span></code>
user.</p>
</div>
<div class="section" id="permissions">
<h2>Permissions<a class="headerlink" href="#permissions" title="Permalink to this headline">¶</a></h2>
<p>So now the last step. We need to protect the &#8220;View Folder&#8221; view with
the permission:</p>
<div class="literal-block-wrapper container" id="id2">
<div class="code-block-caption"><span class="caption-text">mysite/views.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="k">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="k">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">remember</span><span class="p">,</span> <span class="n">forget</span>
<span class="kn">from</span> <span class="nn">.models.folder</span> <span class="k">import</span> <span class="n">RootFolder</span><span class="p">,</span> <span class="n">Folder</span>
<span class="kn">from</span> <span class="nn">.models.document</span> <span class="k">import</span> <span class="n">Document</span>
<span class="kn">from</span> <span class="nn">.security</span> <span class="k">import</span> <span class="n">USERS</span>


<span class="k">class</span> <span class="nc">RootViews</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/root.jinja2&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">RootFolder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">__parent__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/login.jinja2&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/login.jinja2&#39;</span><span class="p">,</span>
                 <span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">login_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">USERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">root</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">form_error</span><span class="o">=</span><span class="s1">&#39;Invalid username or password&#39;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;logout&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">forget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FolderViews</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;templates/folder.jinja2&quot;</span><span class="p">,</span>
                 <span class="n">context</span><span class="o">=</span><span class="n">Folder</span><span class="p">,</span>
<span class="hll">                 <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add_folder&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">Folder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make a new Folder</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;folder_title&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>

        <span class="n">new_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Folder</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># Redirect to the new folder</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">new_folder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DocumentViews</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add_document&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">Folder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make a new Document</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;document_title&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>
        <span class="n">new_document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># Redirect to the new document</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">new_document</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;templates/document.jinja2&quot;</span><span class="p">,</span>
                 <span class="n">context</span><span class="o">=</span><span class="n">Document</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Now, if you run the app and go to the root, you will see two folders
listed. If you are not logged in, then clicking on the second folder
will trigger forbidden.</p>
<p>We could fix this by hiding the second folder. That is, using
Pyramid&#8217;s <code class="docutils literal"><span class="pre">has_permission</span></code> to only generate a <code class="docutils literal"><span class="pre">&lt;li&gt;</span></code> for
folders that the current user is allowed to view. Let&#8217;s give that a try:</p>
<div class="literal-block-wrapper container" id="mysite-templates-contents-jinja2">
<div class="code-block-caption"><span class="caption-text">mysite/templates/contents.jinja2</span><a class="headerlink" href="#mysite-templates-contents-jinja2" title="Permalink to this code">¶</a></div>
<div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="x">&lt;h4&gt;Contents&lt;/h4&gt;</span>

<span class="x">&lt;div class=&quot;row&quot;&gt;</span>
<span class="x">    &lt;ul class=&quot;list-group col-md-6&quot;&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">child</span> <span class="k">in</span> <span class="nv">context.children</span> <span class="cp">%}</span><span class="x"></span>
<span class="hll"><span class="x">        </span><span class="cp">{%</span>  <span class="k">if</span> <span class="nv">request.has_permission</span><span class="o">(</span><span class="s1">&#39;view&#39;</span><span class="o">,</span> <span class="nv">child</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="x">          &lt;li class=&quot;list-group-item&quot;&gt;</span>

<span class="x">              &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">request.resource_url</span><span class="o">(</span><span class="nv">child</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">child.title</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">              &lt;/a&gt;</span>

<span class="x">              &lt;div class=&quot;btn-group  pull-right&quot; role=&quot;group&quot;&gt;</span>
<span class="x">                  &lt;a class=&quot;btn btn-default btn-xs&quot;</span>
<span class="x">                     href=&quot;</span><span class="cp">{{</span> <span class="nv">request.resource_url</span><span class="o">(</span><span class="nv">child</span><span class="o">,</span> <span class="s1">&#39;delete&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">                      &lt;span class=&quot;glyphicon glyphicon-trash&quot;</span>
<span class="x">                            aria-hidden=&quot;true&quot;&gt;&lt;/span&gt; delete</span>
<span class="x">                  &lt;/a&gt;</span>
<span class="x">              &lt;/div&gt;</span>
<span class="x">          &lt;/li&gt;</span>
<span class="hll"><span class="x">        </span><span class="cp">{%</span>  <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="x">      </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="x">&lt;div class=&quot;row&quot;&gt;</span>
<span class="x">    &lt;p&gt;</span>

<span class="x">    &lt;form class=&quot;form-inline&quot;</span>
<span class="x">          action=&quot;</span><span class="cp">{{</span> <span class="nv">request.resource_url</span><span class="o">(</span><span class="nv">context</span><span class="o">,</span> <span class="s1">&#39;add_folder&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">          method=&quot;POST&quot;&gt;</span>
<span class="x">        &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">            &lt;input class=&quot;form-control&quot; name=&quot;folder_title&quot;</span>
<span class="x">                   placeholder=&quot;New folder title...&quot;/&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">        &lt;input type=&quot;submit&quot; class=&quot;btn&quot; value=&quot;Add Folder&quot;/&gt;</span>
<span class="x">    &lt;/form&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="x">    &lt;p&gt;</span>

<span class="x">    &lt;form class=&quot;form-inline&quot;</span>
<span class="x">          action=&quot;</span><span class="cp">{{</span> <span class="nv">request.resource_url</span><span class="o">(</span><span class="nv">context</span><span class="o">,</span> <span class="s1">&#39;add_document&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">          method=&quot;POST&quot;&gt;</span>
<span class="x">        &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">            &lt;input class=&quot;form-control&quot; name=&quot;document_title&quot;</span>
<span class="x">                   placeholder=&quot;New document title...&quot;/&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">        &lt;input type=&quot;submit&quot; class=&quot;btn&quot; value=&quot;Add Document&quot;/&gt;</span>
<span class="x">    &lt;/form&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>We have now hidden any children that we&#8217;re not allowed to see.</p>
</div>
<div class="section" id="to-do">
<h2>To Do<a class="headerlink" href="#to-do" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Better way to do class-based <code class="docutils literal"><span class="pre">default_acl</span></code>? Perhaps a sqla hybrid
property could differentiate between the class-based and table-based</li>
<li>Move the ACL to an ACLType, which included mutation tracking and
centralized the complexity</li>
<li>The &#8220;trickeration&#8221; comment in Node.__acl__</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">ACLs</a><ul>
<li><a class="reference internal" href="#acl-column-type">ACL Column Type</a></li>
<li><a class="reference internal" href="#authentication-and-authorizaton">Authentication and Authorizaton</a></li>
<li><a class="reference internal" href="#id1">ACLs</a></li>
<li><a class="reference internal" href="#permissions">Permissions</a></li>
<li><a class="reference internal" href="#to-do">To Do</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../parents/index.html" title="previous chapter">Parents in One Query</a></li>
      <li>Next: <a href="../filtered_queries/index.html" title="next chapter">Filtered Queries</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/acls/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Paul Everitt.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/acls/index.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>