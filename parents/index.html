<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Parents in One Query &mdash; pyramid_sqltraversal 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pyramid_sqltraversal 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="ACLs" href="../acls/index.html" />
    <link rel="prev" title="Traversal CRUD" href="../traversal_crud/index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="parents-in-one-query">
<h1>Parents in One Query<a class="headerlink" href="#parents-in-one-query" title="Permalink to this headline">¶</a></h1>
<p>Now we get more ambitious. It turns out that getting the parents for a
resource is something we&#8217;ll do a lot of in traversal applications.
Particularly for hierarchical security filtering of a query.</p>
<p>Our current approach uses Pyramid&#8217;s lineage to travel the
<code class="docutils literal"><span class="pre">__parent__</span></code> link, hopping up the parents with
<code class="docutils literal"><span class="pre">reversed(list(lineage(context)))</span></code>. But each call to <code class="docutils literal"><span class="pre">__parent__</span></code>
generates a separate SQL query. That&#8217;s inefficient. What if we could do
it one query?</p>
<p>This is where common table expressions (CTE) comes in, specifically, a
recursive CTE. In this step we add a <code class="docutils literal"><span class="pre">lineage</span></code> method to our
<code class="docutils literal"><span class="pre">Node</span></code> model, which returns all the parents in one query.</p>
<div class="section" id="node">
<h2>Node<a class="headerlink" href="#node" title="Permalink to this headline">¶</a></h2>
<p>First our <code class="docutils literal"><span class="pre">node.py</span></code> changes:</p>
<div class="literal-block-wrapper container" id="mysite-models-node-py-node-lineage">
<div class="code-block-caption"><span class="caption-text">mysite/models/node.py, Node.lineage</span><a class="headerlink" href="#mysite-models-node-py-node-lineage" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">lineage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="n">init_cte</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">Node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">Node</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
                <span class="n">literal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lineage&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">child_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">init_cte</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;child&#39;</span><span class="p">)</span>
        <span class="n">parent_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="n">lineage_cte</span> <span class="o">=</span> <span class="n">init_cte</span><span class="o">.</span><span class="n">union_all</span><span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">parent_alias</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">parent_alias</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
                <span class="n">child_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent_alias</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">child_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lineage_cte</span><span class="p">,</span> <span class="n">Node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">lineage_cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">lineage_cte</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>This is complicated SQLAlchemy, but it does the trick. For performance
reasons, it turns off polymorphism during the query for the recursion,
then once it has found the nodes in the lineage, returns those with
polymorphism back on.</p>
</div>
<div class="section" id="views">
<h2>Views<a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h2>
<p>The only change in our views is to remove
<code class="docutils literal"><span class="pre">self.parents</span> <span class="pre">=</span> <span class="pre">reversed(list(lineage(context)))</span></code> from the view class
constructor. The context is an instance of a model that derives from
Node. Pyramid templates have a <code class="docutils literal"><span class="pre">context</span></code> available (in addition to
<code class="docutils literal"><span class="pre">request</span></code> and <code class="docutils literal"><span class="pre">view</span></code>.) So instead, we can just do this directly:</p>
<div class="literal-block-wrapper container" id="base-jinja2">
<div class="code-block-caption"><span class="caption-text">base.jinja2</span><a class="headerlink" href="#base-jinja2" title="Permalink to this code">¶</a></div>
<div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html lang=&quot;en&quot;&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;title&gt;</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"> - MySite&lt;/title&gt;</span>
<span class="x">    &lt;link rel=&quot;stylesheet&quot;</span>
<span class="x">          href=&quot;//oss.maxcdn.com/bootstrap/3.3.4/css/bootstrap.css&quot;&gt;</span>
<span class="x">    &lt;link rel=&quot;stylesheet&quot;</span>
<span class="x">          href=&quot;</span><span class="cp">{{</span> <span class="nv">request.static_url</span><span class="o">(</span><span class="s1">&#39;mysite:static/mysite.css&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">    &lt;link rel=&quot;shortcut icon&quot;</span>
<span class="x">          href=&quot;request.static_url(&#39;mysite:static/pyramid-16x16.png&#39;)&quot;&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>

<span class="x">&lt;nav class=&quot;navbar navbar-inverse&quot;&gt;</span>
<span class="x">    &lt;div class=&quot;navbar-header&quot;&gt;</span>
<span class="x">        &lt;a class=&quot;navbar-brand&quot;</span>
<span class="x">           href=&quot;</span><span class="cp">{{</span> <span class="nv">request.resource_url</span><span class="o">(</span><span class="nv">request.root</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">          </span><span class="cp">{{</span> <span class="nv">request.root.title</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span class="x">        &lt;li&gt;</span>
<span class="x">        &lt;/li&gt;</span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">&lt;/nav&gt;</span>

<span class="x">&lt;div id=&quot;content&quot; class=&quot;container&quot;&gt;</span>
<span class="x">    &lt;ol class=&quot;breadcrumb&quot;&gt;</span>

<span class="hll"><span class="x">      </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">p</span> <span class="k">in</span> <span class="nv">context.lineage</span><span class="o">|</span><span class="nf">reverse</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="x">          &lt;li&gt;&lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">request.resource_url</span><span class="o">(</span><span class="nv">p</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">p.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">          &lt;/li&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ol&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;script src=&quot;//oss.maxcdn.com/jquery/2.1.3/jquery.js&quot;&gt;&lt;/script&gt;</span>
<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>That is, we use <code class="docutils literal"><span class="pre">context.lineage|reverse</span></code>.</p>
</div>
<div class="section" id="to-do">
<h2>To Do<a class="headerlink" href="#to-do" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>At this point, probably time to start thinking about synthesizing
huge data sets, bulk loading, then measuring some PG query planner
time</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Parents in One Query</a><ul>
<li><a class="reference internal" href="#node">Node</a></li>
<li><a class="reference internal" href="#views">Views</a></li>
<li><a class="reference internal" href="#to-do">To Do</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../traversal_crud/index.html" title="previous chapter">Traversal CRUD</a></li>
      <li>Next: <a href="../acls/index.html" title="next chapter">ACLs</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/parents/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Paul Everitt.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/parents/index.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>