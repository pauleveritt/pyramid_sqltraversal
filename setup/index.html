<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Pyramid and SQLAlchemy Setup &mdash; pyramid_sqltraversal 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pyramid_sqltraversal 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="Simple Traversal" href="../simple_traversal/index.html" />
    <link rel="prev" title="Welcome to pyramid_sqltraversal documentation!" href="../index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pyramid-and-sqlalchemy-setup">
<h1>Pyramid and SQLAlchemy Setup<a class="headerlink" href="#pyramid-and-sqlalchemy-setup" title="Permalink to this headline">¶</a></h1>
<p>Pyramid and SQLAlchemy are great friends, but there are different
approaches to integrating the two. <code class="docutils literal"><span class="pre">pyramid_sqlalchemy</span></code> is one, but
uses globals. Recently, the Pyramid scaffold has adopted some best
practices.</p>
<p>In this step we make a Pyramid application based on those best
practices. This app will:</p>
<ul class="simple">
<li>Connect to a SQLite database using SQLAlchemy</li>
<li>Provide a console script that populates the database</li>
<li>Give one view that returns JSON</li>
<li>Provide a request hook helper for conveniently getting at the database
session</li>
</ul>
<p>We will <em>not</em> write this as a library in this step. We will instead go
all the way through writing an application, and <em>then</em> write a
<code class="docutils literal"><span class="pre">pyramid_sqltraversal</span></code> library.</p>
<div class="section" id="setup-py">
<h2><code class="docutils literal"><span class="pre">setup.py</span></code><a class="headerlink" href="#setup-py" title="Permalink to this headline">¶</a></h2>
<p>Our <code class="docutils literal"><span class="pre">setup.py</span></code> is straightforward. It includes some packages and sets
up our Pyramid entry points:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="k">import</span> <span class="n">setup</span>

<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;pyramid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_tm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SQLAlchemy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;transaction&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zope.sqlalchemy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;waitress&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nose&#39;</span><span class="p">,</span>
    <span class="s1">&#39;webtest&#39;</span>
<span class="p">]</span>
<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mysite&#39;</span><span class="p">,</span>
      <span class="n">install_requires</span><span class="o">=</span><span class="n">requires</span><span class="p">,</span>
      <span class="n">entry_points</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">      [paste.app_factory]</span>
<span class="s2">      main = mysite:main</span>
<span class="s2">      [console_scripts]</span>
<span class="s2">      initialize_db = mysite.scripts.initialize_db:main</span>
<span class="s2">      &quot;&quot;&quot;</span>
      <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>We will use SQLite for as long as we can, then switch to PostgreSQL.</p>
<p>Things that could be better:</p>
<ul class="simple">
<li><em>Dependencies</em>. The dependencies need to be re-organized. Put sphinx,
nose, webtest, etc. as dev dependences.*</li>
<li><em>pytest</em>. If that&#8217;s considered more modern, use it.</li>
<li><em>Unit and functional tests</em>. I didn&#8217;t actually write any. Not only
that, sure would be nice for some <code class="docutils literal"><span class="pre">pyramid_sqltraversal</span></code> library
to provide some fixture helpers. Could look at <a class="reference external" href="https://github.com/Pylons/pyramid/commit/411eecbedc54d425efa1b03d70f084023e71b6f7">this commit</a> for some inspiration.</li>
</ul>
</div>
<div class="section" id="development-ini">
<h2><code class="docutils literal"><span class="pre">development.ini</span></code><a class="headerlink" href="#development-ini" title="Permalink to this headline">¶</a></h2>
<p>Our <code class="docutils literal"><span class="pre">pserve</span></code> configuration file is simple:</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">[app:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:mysite</span>
<span class="na">pyramid.includes</span> <span class="o">=</span><span class="s"></span>
<span class="s">    pyramid_tm</span>
<span class="na">sqlalchemy.url</span> <span class="o">=</span> <span class="s">sqlite:///%(here)s/mysite.sqlite</span>

<span class="k">[server:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:waitress#main</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">0.0.0.0</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">6543</span>
</pre></div>
</td></tr></table></div>
<p>Only thing to note: we include <code class="docutils literal"><span class="pre">pyramid_tm</span></code> in the ini file, rather
than imperatively in the code, because it should be possible to run a
site with transactions off (read-only).</p>
</div>
<div class="section" id="loader-console-script">
<h2>Loader Console Script<a class="headerlink" href="#loader-console-script" title="Permalink to this headline">¶</a></h2>
<p>Our <code class="docutils literal"><span class="pre">setup.py</span></code> entry point defined an <code class="docutils literal"><span class="pre">initialize_db</span></code> console
script:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">transaction</span>

<span class="kn">from</span> <span class="nn">pyramid.paster</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_appsettings</span><span class="p">,</span>
    <span class="n">setup_logging</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.scripts.common</span> <span class="k">import</span> <span class="n">parse_vars</span>

<span class="kn">from</span> <span class="nn">..models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Base</span><span class="p">,</span>
    <span class="n">get_session</span><span class="p">,</span>
    <span class="n">get_engine</span><span class="p">,</span>
    <span class="n">get_dbmaker</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..models.node</span> <span class="k">import</span> <span class="n">Node</span>


<span class="k">def</span> <span class="nf">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;usage: </span><span class="si">%s</span><span class="s1"> &lt;config_uri&gt; [var=value]</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="s1">&#39;(example: &quot;</span><span class="si">%s</span><span class="s1"> development.ini&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">config_uri</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_vars</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">setup_logging</span><span class="p">(</span><span class="n">config_uri</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_appsettings</span><span class="p">(</span><span class="n">config_uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">dbmaker</span> <span class="o">=</span> <span class="n">get_dbmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">,</span> <span class="n">dbmaker</span><span class="p">)</span>

    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>After some basic imports, we get stuff needed from our models:</p>
<ul class="simple">
<li>The models themselves</li>
<li>The imports of the engine-y stuff</li>
</ul>
<p>Our main function parses the command-line argument to get the
configuration file, sets up logging, and then does a four-part dance
to get the database setup:</p>
<ul class="simple">
<li>Get the engine</li>
<li>Get the dbmaker using the engine</li>
<li>Get the session using the dbmaker</li>
<li>Bootstrap the SQLAlchemy metadata base using the engine.</li>
</ul>
<p>It is <em>important</em> for this module to import any models that are needed,
<em>before</em> bootstrapping the metadata. This point will lead to duplicate
model imports in this console script and in the actual running Pyramid
code.</p>
<p>Things that could be better:</p>
<ul class="simple">
<li><em>request.dbsession in console script</em>. <code class="docutils literal"><span class="pre">request.dbsession</span></code> is
awesome, when you&#8217;re in a request. We&#8217;re not, so we have to do all
that work ourselves. Anyway to abstract the helper so it can provide
a console-script-oriented helper?</li>
<li><em>Lots of boilerplate</em>. Later, when we write a library, we should make
writing console scripts a lot easier. They are all going to want to
parse the ini file passed in, get the settings.</li>
<li><em>Double model imports</em>. Any way to avoid duplication of imports for
all of your models?</li>
</ul>
</div>
<div class="section" id="models">
<h2><code class="docutils literal"><span class="pre">models</span></code><a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h2>
<p>Before getting into the app server code, let&#8217;s look at the models, as
they were just used in the console script.</p>
<p>The <code class="docutils literal"><span class="pre">models</span></code> directory is a Python package with an <code class="docutils literal"><span class="pre">__init__.py</span></code>.
Just like Pyramid uses this file as a place to wire together your WSGI
application, SQLAlchemy users commonly put their models in a directory
with common wire-up in the directory/package <code class="docutils literal"><span class="pre">__init__.py</span></code>:</p>
<div class="literal-block-wrapper container" id="mysite-models-init-py">
<div class="code-block-caption"><span class="caption-text">mysite/models/__init__.py</span><a class="headerlink" href="#mysite-models-init-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">engine_from_config</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="k">import</span> <span class="n">MetaData</span>
<span class="kn">import</span> <span class="nn">zope.sqlalchemy</span>
<span class="kn">from</span> <span class="nn">.node</span> <span class="k">import</span> <span class="n">Node</span>

<span class="n">NAMING_CONVENTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ix&quot;</span><span class="p">:</span> <span class="s1">&#39;ix_</span><span class="si">%(column_0_label)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;uq_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;ck_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(constraint_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span> <span class="s2">&quot;fk_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_</span><span class="si">%(referred_table_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="s2">&quot;pk_</span><span class="si">%(table_name)s</span><span class="s2">&quot;</span>
<span class="p">}</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">naming_convention</span><span class="o">=</span><span class="n">NAMING_CONVENTION</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="n">transaction_manager</span><span class="p">,</span> <span class="n">dbmaker</span><span class="p">):</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">dbmaker</span><span class="p">()</span>
    <span class="n">zope</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span>
                             <span class="n">transaction_manager</span><span class="o">=</span><span class="n">transaction_manager</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbsession</span>


<span class="k">def</span> <span class="nf">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sqlalchemy.&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_dbmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="n">dbmaker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
    <span class="n">dbmaker</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbmaker</span>


<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">dbmaker</span> <span class="o">=</span> <span class="n">get_dbmaker</span><span class="p">(</span><span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">get_session</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tm</span><span class="p">,</span> <span class="n">dbmaker</span><span class="p">),</span>
        <span class="s1">&#39;dbsession&#39;</span><span class="p">,</span>
        <span class="n">reify</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>This file acts as the central bootstrapping point for SQLAlchemy, as
well as its integration into Pyramid. We start with the basic imports
for SQLAlchemy in Pyramid.</p>
<p>The <code class="docutils literal"><span class="pre">NAMING_CONVENTION</span></code> block uses a SQLAlchemy best practice for
various definitions, as suggested by
<a class="reference external" href="http://alembic.readthedocs.org/en/latest/naming.html">SQLAlchemy/Alembic documentation</a>.</p>
<p>Then the important part: the SQLAlchemy metadata base is wired up in
<em>local</em> scope, with functions that return the session, engine, and
dbmaker to other modules.</p>
<p>It&#8217;s import to import your models in this file, as we do with <code class="docutils literal"><span class="pre">Node</span></code>.</p>
<p>Finally, we provide a Pyramid <code class="docutils literal"><span class="pre">includeme</span></code> function to make it easy to
apply all of our model and SQLAlchemy setup with a simple
<code class="docutils literal"><span class="pre">config.include('.models')</span></code> in our Pyramid bootstrapping. This
<code class="docutils literal"><span class="pre">includeme</span></code> function has a very important addition: we add a custom
method <code class="docutils literal"><span class="pre">dbsession</span></code> to Pyramid&#8217;s request, allowing easy access to the
session in Pyramid code. Simply do <code class="docutils literal"><span class="pre">request.dbsession</span></code> to get the
session. <code class="docutils literal"><span class="pre">reify=True</span></code> turns the method into a property, one that is
cached for the duration of a request.</p>
<p>Our sample application at this point has one model called <code class="docutils literal"><span class="pre">Node</span></code> in
<code class="docutils literal"><span class="pre">models/node.py</span></code>:</p>
<div class="literal-block-wrapper container" id="mysite-models-node-py">
<div class="code-block-caption"><span class="caption-text">mysite/models/node.py</span><a class="headerlink" href="#mysite-models-node-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">Integer</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Base</span>


<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;nodes&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">root_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>


<span class="n">sample_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">dict</span><span class="p">(),</span>
    <span class="nb">dict</span><span class="p">()</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Nothing major here...a table with a single column <code class="docutils literal"><span class="pre">id</span></code>. We follow the
convention of singular class name <code class="docutils literal"><span class="pre">Node</span></code> and plural table name
<code class="docutils literal"><span class="pre">nodes</span></code>. We also provide some sample data for this model that the
initializer script can use during development.</p>
<p>We do, however, make a Pyramid &#8220;root factory&#8221; for the application. This
is a function registered with the Pyramid configuration which, on each
request, gets run and returns an object to act as the &#8220;root&#8221; of the
resource tree.</p>
<ul>
<li><p class="first">Pyramid/SQLAlchemy best practices</p>
<blockquote>
<div><ul class="simple">
<li>Class (singular) and table (plural)</li>
<li>root factory</li>
<li>config.include models, to put common model wiring in the subpackage</li>
<li>context-based views, versus routes</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Some kind of test console script that exercises the API</p>
</li>
</ul>
<p>Things that could be improved:</p>
<ul class="simple">
<li><em>Sample Data</em>. Putting sample data in each model won&#8217;t really work,
as we need to create a tree with a mixture of data from different
models.</li>
</ul>
</div>
<div class="section" id="web-app-setup">
<h2>Web App Setup<a class="headerlink" href="#web-app-setup" title="Permalink to this headline">¶</a></h2>
<p>We not have a Python package with console scripts and database models.
We need to get Pyramid setup and add a view.</p>
<p>Our <code class="docutils literal"><span class="pre">__init__.py</span></code>:</p>
<div class="literal-block-wrapper container" id="mysite-init-py">
<div class="code-block-caption"><span class="caption-text">mysite/__init__.py</span><a class="headerlink" href="#mysite-init-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="k">import</span> <span class="n">Configurator</span>

<span class="kn">from</span> <span class="nn">.models.node</span> <span class="k">import</span> <span class="n">root_factory</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
        <span class="n">root_factory</span><span class="o">=</span><span class="n">root_factory</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.models&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s1">&#39;.views&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>We import the root factory and pass it into our <code class="docutils literal"><span class="pre">Configurator</span></code> setup.
We use <code class="docutils literal"><span class="pre">config.include('.models')</span></code> to do all the lifting for model
setup.</p>
<p>Our view is equally simple:</p>
<div class="literal-block-wrapper container" id="mysite-views-py">
<div class="code-block-caption"><span class="caption-text">mysite/views.py</span><a class="headerlink" href="#mysite-views-py" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="k">import</span> <span class="n">view_config</span><span class="p">,</span> <span class="n">view_defaults</span>

<span class="kn">from</span> <span class="nn">.models.node</span> <span class="k">import</span> <span class="n">Node</span>


<span class="nd">@view_defaults</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MySite</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">Node</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">root_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>We have a view class with one view. The view class grabs the request
<em>and</em> the context, which comes from the root factory.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>In this step we setup best practices for Pyramid and SQLAlchemy. We
stayed away from making this into a library. We also stayed away from
almost everything to do with traversal.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Pyramid and SQLAlchemy Setup</a><ul>
<li><a class="reference internal" href="#setup-py"><code class="docutils literal"><span class="pre">setup.py</span></code></a></li>
<li><a class="reference internal" href="#development-ini"><code class="docutils literal"><span class="pre">development.ini</span></code></a></li>
<li><a class="reference internal" href="#loader-console-script">Loader Console Script</a></li>
<li><a class="reference internal" href="#models"><code class="docutils literal"><span class="pre">models</span></code></a></li>
<li><a class="reference internal" href="#web-app-setup">Web App Setup</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../index.html" title="previous chapter">Welcome to pyramid_sqltraversal documentation!</a></li>
      <li>Next: <a href="../simple_traversal/index.html" title="next chapter">Simple Traversal</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/setup/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Paul Everitt.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/setup/index.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>